<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento IA Multimodal - Saúde da Mulher</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1500.0.min.js"></script>
    <style>
        :root { --primary: #d81b60; --bg: #f8f9fa; --accent: #ffd54f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 700px; }
        h1 { color: var(--primary); text-align: center; margin-bottom: 5px; }
        .upload-area { border: 2px dashed #ccc; padding: 30px; border-radius: 10px; text-align: center; cursor: pointer; margin: 20px 0; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary); background: #fff0f5; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 25px; width: 100%; font-size: 16px; cursor: pointer; font-weight: bold; }
        .btn:disabled { background: #ccc; }
        
        #status-container { margin-top: 25px; display: none; }
        .progress-bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }
        .log-container { background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; padding: 15px; border-radius: 8px; font-size: 13px; max-height: 150px; overflow-y: auto; }
        
        #final-result { margin-top: 25px; display: none; background: #fff; padding: 20px; border-radius: 10px; border-left: 5px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .evidence-box { background: #fff9c4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--accent); }
        .evidence-title { font-weight: bold; color: #7f6d00; margin-bottom: 10px; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 14px; line-height: 1.6; color: #333; }
    </style>
</head>
<body>

<div class="card">
    <h1>Saúde da Mulher IA</h1>
    <p style="text-align:center; color:#666">Detecção Multimodal de Violência Doméstica</p>

    <div class="upload-area" id="drop-zone" onclick="document.getElementById('fileInput').click()">
        <p id="file-label">Clique para selecionar o vídeo (MP4)</p>
        <input type="file" id="fileInput" accept="video/mp4" style="display:none" onchange="handleFileSelect()">
    </div>

    <button class="btn" id="startBtn" onclick="startAnalysis()" disabled>Iniciar Análise</button>

    <div id="status-container">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px">
            <span id="current-step" style="font-weight:bold; color:var(--primary)">Aguardando...</span>
            <span id="progress-text">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <div class="log-container" id="log-box"></div>
    </div>

    <div id="final-result">
        <div class="evidence-box" id="evidence-section">
            <div class="evidence-title">⚠️ EVIDÊNCIAS QUE EMBASAM O SCORE:</div>
            <div id="evidence-list" style="font-size: 14px; color: #555;">Analisando dados...</div>
        </div>
        <h3 style="color:var(--primary); margin-top:0">Relatório Clínico Detalhado</h3>
        <pre id="report-content"></pre>
    </div>
</div>

<script>
    // CONFIGURAÇÕES AWS - ATENÇÃO: PREENCHA ESTES CAMPOS
    const BUCKET_NAME = 'dvd-upload-videos'; 
    const REGION = 'us-east-1';
    const IDENTITY_POOL_ID = 'us-east-1:2adcf785-2fa0-4338-88ef-a88cc6b7270c';

    AWS.config.update({ region: REGION, credentials: new AWS.CognitoIdentityCredentials({ IdentityPoolId: IDENTITY_POOL_ID }) });
    
    // Usar S3 com assinatura v4 e sem verificação de bucket desnecessária
    const s3 = new AWS.S3({ apiVersion: '2006-03-01', computeChecksums: true });

    let selectedFile = null;
    const steps = ["INIT", "VIDEO_START", "AUDIO_START", "VIDEO_WAIT", "VIDEO_DONE", "AUDIO_WAIT", "AUDIO_DONE", "TEXT_ANALYSIS", "FUSION", "COMPLETED"];

    function handleFileSelect() {
        selectedFile = document.getElementById('fileInput').files[0];
        if (selectedFile) {
            document.getElementById('file-label').innerText = "Arquivo: " + selectedFile.name;
            document.getElementById('startBtn').disabled = false;
        }
    }

    function addLog(msg) {
        const box = document.getElementById('log-box');
        const time = new Date().toLocaleTimeString();
        box.innerHTML += `<div><span style="color:#888">[${time}]</span> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    async function startAnalysis() {
        const fileId = selectedFile.name.split('.')[0];
        document.getElementById('startBtn').disabled = true;
        document.getElementById('status-container').style.display = 'block';
        document.getElementById('final-result').style.display = 'none';
        document.getElementById('log-box').innerHTML = "";
        
        addLog("Iniciando upload direto para o S3...");
        
        try {
            // Usar putObject em vez de upload para evitar s3:ListBucket
            await s3.putObject({ 
                Bucket: BUCKET_NAME, 
                Key: 'uploads/' + selectedFile.name, 
                Body: selectedFile, 
                ContentType: selectedFile.type 
            }).promise();
            
            addLog("Upload concluído com sucesso. Iniciando monitoramento...");
            pollStatus(fileId);
        } catch (e) {
            addLog("ERRO NO UPLOAD: " + e.message);
            console.error(e);
            document.getElementById('startBtn').disabled = false;
        }
    }

    async function pollStatus(fileId) {
        const statusKey = 'status/' + fileId + '.json';
        const reportKey = 'reports/' + fileId + '_report.json';
        let lastStep = "";

        const interval = setInterval(async () => {
            try {
                const data = await s3.getObject({ Bucket: BUCKET_NAME, Key: statusKey }).promise();
                const statusObj = JSON.parse(data.Body.toString());

                if (statusObj.step !== lastStep) {
                    lastStep = statusObj.step;
                    const progress = Math.round((steps.indexOf(statusObj.step) + 1) / steps.length * 100);
                    document.getElementById('current-step').innerText = statusObj.message;
                    document.getElementById('progress-text').innerText = progress + "%";
                    document.getElementById('progress-fill').style.width = progress + "%";
                    addLog(statusObj.message);
                }

                if (statusObj.step === "COMPLETED") {
                    clearInterval(interval);
                    addLog("Buscando relatório final...");
                    const reportData = await s3.getObject({ Bucket: BUCKET_NAME, Key: reportKey }).promise();
                    const finalData = JSON.parse(reportData.Body.toString());
                    
                    const fullReport = finalData.report;
                    const evidenceMatch = fullReport.match(/EVIDÊNCIAS QUE EMBASAM O SCORE([\s\S]*?)4\./i);
                    
                    document.getElementById('evidence-list').innerText = evidenceMatch ? evidenceMatch[1].trim() : "Consulte o relatório detalhado abaixo.";
                    document.getElementById('report-content').innerText = fullReport;
                    document.getElementById('final-result').style.display = 'block';
                    document.getElementById('startBtn').disabled = false;
                }
                
                if (statusObj.step === "ERROR") {
                    clearInterval(interval);
                    addLog("ERRO NO PROCESSO: " + statusObj.message);
                    document.getElementById('startBtn').disabled = false;
                }
            } catch (e) { 
                if (e.code !== 'NoSuchKey' && e.code !== 'AccessDenied') {
                    console.error("Erro no polling:", e);
                }
            }
        }, 5000);
    }
</script>

</body>
</html>
